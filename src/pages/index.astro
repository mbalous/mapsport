---
// src/pages/index.astro
import "../styles/global.css";
import MapUI from "../components/MapUI.astro";
import { fetchStravaActivities, fetchStravaAthlete } from "../lib/strava";

const token = Astro.cookies.get("strava_access_token")?.value;

let initialActivities: any[] = [];
let userProfile = null;
let errorMsg = null;

if (token) {
  try {
    const [activitiesRes, athleteRes] = await Promise.all([
      fetchStravaActivities(token, 1, 30),
      fetchStravaAthlete(token).catch(() => null), // Ignore athlete fetch errors
    ]);
    initialActivities = activitiesRes;
    userProfile = athleteRes;
  } catch (err: any) {
    if (err.message.includes("expired") || err.message.includes("failed")) {
      // Clear cookie if expired and force re-login
      Astro.cookies.delete("strava_access_token", { path: "/" });
      errorMsg = "Your session expired. Please log in again.";
    } else {
      errorMsg = err.message;
    }
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <title>Strava Artistic Map</title>
  </head>
  <body class="bg-gray-950 text-white min-h-screen">
    {
      token && !errorMsg ? (
        <MapUI
          initialActivities={initialActivities}
          userProfile={userProfile}
        />
      ) : (
        <div class="relative min-h-screen flex items-center justify-center overflow-hidden">
          {/* Abstract Background Elements */}
          <div class="absolute inset-0 z-0">
            <div class="absolute top-1/4 left-1/4 w-[500px] h-[500px] bg-orange-600/20 blur-[100px] rounded-full mix-blend-screen opacity-50 animate-pulse" />
            <div class="absolute bottom-1/4 right-1/4 w-[600px] h-[600px] bg-rose-600/20 blur-[120px] rounded-full mix-blend-screen opacity-40" />
            <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjQiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSIvPjwvc3ZnPg==')] opacity-20" />
          </div>

          <div class="relative z-10 container mx-auto px-6 py-24 flex flex-col items-center text-center">
            <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-orange-400 text-sm font-medium mb-8 backdrop-blur-sm">
              <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse" />
              Aesthetic Activity Mapping
            </div>

            <h1 class="text-6xl md:text-8xl font-extrabold tracking-tight mb-8">
              Visualize Your <br />
              <span class="text-transparent bg-clip-text bg-gradient-to-r from-orange-400 via-red-500 to-rose-500">
                Adventures
              </span>
            </h1>

            <p class="text-xl md:text-2xl text-gray-400 max-w-3xl mb-12 leading-relaxed">
              Connect your Strava account to instantly combine and render your
              rides, runs, and hikes into stunning, high-resolution aesthetic
              maps.
            </p>

            {errorMsg && (
              <div class="mb-10 px-6 py-4 bg-red-950/50 border border-red-800 rounded-2xl text-red-300 backdrop-blur-md font-medium flex items-center gap-3">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="12" cy="12" r="10" />
                  <line x1="12" y1="8" x2="12" y2="12" />
                  <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
                {errorMsg}
              </div>
            )}

            <div class="flex flex-col sm:flex-row gap-6 items-center">
              <a
                href="/api/auth/login"
                class="group relative inline-flex items-center gap-3 px-8 py-4 rounded-full bg-[#FC4C02] transition-all font-bold text-lg text-white overflow-hidden hover:scale-105"
              >
                <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 ease-out" />
                <svg
                  class="w-6 h-6 relative z-10"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M15.387 17.944l-2.089-4.116h-3.065L15.387 24l5.15-10.172h-3.066m-7.008-5.599l2.836 5.598h4.172L10.463 0l-7 13.828h4.169" />
                </svg>
                <span class="relative z-10">Connect with Strava</span>
              </a>

              <a
                href="#features"
                class="px-8 py-4 rounded-full bg-white/5 border border-white/10 hover:bg-white/10 transition-colors font-medium text-lg text-gray-300 backdrop-blur-sm"
              >
                Learn More
              </a>
            </div>

            {/* Feature Grid */}
            <div
              id="features"
              class="grid md:grid-cols-3 gap-8 mt-32 max-w-5xl text-left border-t border-white/10 pt-20"
            >
              <div class="p-6 rounded-3xl bg-white/5 border border-white/5 backdrop-blur-sm hover:bg-white/10 transition-colors">
                <div class="w-12 h-12 rounded-2xl bg-orange-500/20 text-orange-400 flex items-center justify-center mb-6">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <>
                      <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z" />
                      <circle cx="12" cy="10" r="3" />
                    </>
                  </svg>
                </div>
                <h3 class="text-xl font-bold mb-3 text-white">Premium Maps</h3>
                <p class="text-gray-400 leading-relaxed">
                  Beautiful CartoDB Dark Matter tiles provide stunning contrast
                  for your vibrant activity overlays.
                </p>
              </div>

              <div class="p-6 rounded-3xl bg-white/5 border border-white/5 backdrop-blur-sm hover:bg-white/10 transition-colors">
                <div class="w-12 h-12 rounded-2xl bg-rose-500/20 text-rose-400 flex items-center justify-center mb-6">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold mb-3 text-white">
                  Combine Activities
                </h3>
                <p class="text-gray-400 leading-relaxed">
                  Select up to 10 activities at once. Calculate combined
                  distance, time, and elevation effortlessly.
                </p>
              </div>

              <div class="p-6 rounded-3xl bg-white/5 border border-white/5 backdrop-blur-sm hover:bg-white/10 transition-colors">
                <div class="w-12 h-12 rounded-2xl bg-purple-500/20 text-purple-400 flex items-center justify-center mb-6">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <>
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                      <polyline points="7 10 12 15 17 10" />
                      <line x1="12" x2="12" y1="15" y2="3" />
                    </>
                  </svg>
                </div>
                <h3 class="text-xl font-bold mb-3 text-white">
                  High-Res Export
                </h3>
                <p class="text-gray-400 leading-relaxed">
                  Download a beautiful, pixel-perfect PNG composition of your
                  map and statistics, automatically named after your first
                  selected activity.
                </p>
              </div>
            </div>
          </div>
        </div>
      )
    }
  </body>
</html>
